name: Download and Upload

on:
  push:
    paths:
      - "downloads.txt"
  workflow_dispatch:

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 ffmpeg python3 python3-pip curl
          sudo -v ; curl https://rclone.org/install.sh | sudo bash
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+x /usr/local/bin/yt-dlp
          pip3 install playwright 2>&1 | tail -3
          playwright install chromium 2>&1 | tail -3

      - name: Configure Rclone
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf

      - name: Run Processing Script
        env:
          RCLONE_REMOTE: mega
        run: |
          chmod +x process.sh
          ./process.sh

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          # Discard changes to process.sh (like chmod)
          git checkout process.sh

          git add downloads.txt completed.txt failed.txt

          # Only commit if there are changes
          if ! git diff --quiet || ! git diff --staged --quiet; then
            git commit -m "Update downloads and completed lists"
            
            # Retry loop for push to handle race conditions
            n=0
            until [ "$n" -ge 5 ]
            do
               git pull --rebase && git push && break
               n=$((n+1))
               sleep 5
            done
          fi
